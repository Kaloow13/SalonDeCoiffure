<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Prise de Rendez-vous</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <link href='https://unpkg.com/fullcalendar@5 /main.min.css' rel='stylesheet' />
    <script src='https://unpkg.com/fullcalendar@5/main.min.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        body {
            display: flex;
            min-height: 100vh;
        }

        form,
        #calendar {
            background-color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        form {
            background-color: rgb(141, 141, 141);
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        select,
        button {
            padding: 10px;
            margin-right: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        button {
            background-color: #0056b3;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #004494;
        }

        #results {
            margin-top: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #calendar {
            margin-top: 20px;
            padding: 10px;
            background: rgb(141, 141, 141);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #detailsRDV {
            width: 100%;
            max-width: 300px;
            height: 350px;
            padding: 20px;
            margin-top: 20px;
            background-color: rgb(49, 49, 49);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .container {
            display: flex;
            width: 100%;
            align-items: stretch;
        }

        .left-panel {
            flex: 1;
            background-color: #1f1f1f;
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            flex: 1;
            background: url('https://i.pinimg.com/564x/bd/62/9c/bd629c7afd65382401bb9a46fce6a0dd.jpg') center/cover no-repeat;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .fc-daygrid-event {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fc-daygrid-day-events {
            overflow-y: auto;
            max-height: 100px;
        }

        .close-button {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            font-weight: 400;
            color: white;
            font-size: 14px;
            border: none;
            cursor: pointer;
            font-size: 40px;
            border-radius: 50%;
            text-decoration: none;
        }

        #searchButton {
            background-color: black;
        }

        #confirmButton {
            background-color: black;
            justify-content: center;
            align-items: center;
            align-content: center;
        }

        #detailsRDV {
            color: white;
            justify-content: center;
            align-items: center;
            align-content: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="left-panel">
            <form id="searchForm">
                <select id="coiffeurSelect" style="width: 100%;">
                    <option value="">Choisir un coiffeur</option>
                </select>
                <select id="salonSelect" style="width: 100%;">
                    <option value="">Choisir un salon</option>
                </select>
                <select id="serviceSelect" style="width: 100%;">
                    <option value="">Choisir un service</option>
                </select>

                <button type="button" id="searchButton">Rechercher</button>
            </form>
            <div id="calendar"></div>
        </div>
        <div class="right-panel">
            <div id="detailsRDV" style="display: none;">
                <h2>Détails du Rendez-vous</h2>
                <p id="detailCoiffeur"></p>
                <p id="detailSalon"></p>
                <p id="detailDateTime"></p>
                <p id="detailTime"></p> <!-- Nouvel élément pour l'heure -->
                <button id="confirmButton">Confirmer</button>
            </div>

            <a href="accueil/accueil.html" class="close-button">X</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('.close-button').addEventListener('click', function () {
                window.history.back() //retourner a la page precedente
            });

            fetchAndPopulateSelect('/nomsSalons', 'salonSelect', 'nomSalon', 'Chercher par salon');
            fetchAndPopulateSelect('/coiffeurs', 'coiffeurSelect', 'nomCoiffeur', 'Chercher par coiffeur');
            fetchAndPopulateSelect('/showServices', 'serviceSelect', 'nom', 'Chercher par service');

            function fetchAndPopulateSelect(url, selectId, propertyName, placeholder) {
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.message) { // reponse en message
                            data = data.coiffeurs || data.services;
                        }
                        loadSelectOptions(data, selectId, propertyName, placeholder);
                    })
                    .catch(error => {
                        console.error('Erreur lors de la récupération des données:', error);
                    });
            }

            function loadSelectOptions(data, selectId, propertyName, placeholderText) {
                const select = document.getElementById(selectId);
                let optionsHtml = '<option></option>';  // option vide
                data.forEach(item => {
                    let value = item.id || item.idSalon || item.idCoiffeur || item.idService;
                    let text = item.prenomCoiffeur ? `${item.prenomCoiffeur} ${item[propertyName]}` : item[propertyName]; // concaténer prénom et nom si prénom existe
                    optionsHtml += `<option value="${value}">${text}</option>`;
                });
                select.innerHTML = optionsHtml;
                $(`#${selectId}`).select2({
                    placeholder: placeholderText,
                    allowClear: true
                });
            }

            // Initialiser le calendrier
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                eventClick: afficherDetailsRdv
            });
            calendar.render();

            function fetchAvailabilitiesAndUpdateCalendar() {
                const coiffeurId = document.getElementById('coiffeurSelect').value;
                const salonId = document.getElementById('salonSelect').value;
                const serviceId = document.getElementById('serviceSelect').value;
                console.log(serviceId & "test")

                const queryParams = new URLSearchParams();
                // Ajoute chaque paramètre seulement s'il est défini et non vide
                if (coiffeurId) queryParams.set('idCoiffeur', coiffeurId);
                if (salonId) queryParams.set('idSalon', salonId);
                if (serviceId) queryParams.set('idService', serviceId);

                const queryString = queryParams.toString();
                console.log("Query String:", queryString); // Debug pour voir la chaîne de requête formée

                // Continue seulement si au moins un paramètre est défini
                if (!queryString) {
                    console.log("Aucun critère de recherche n'a été défini.");
                    return;
                }

                fetch(`/disponibilites?${queryString}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error, status = ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Data received:", data); // Affiche les données reçues du serveur
                        if (data.disponibilites && data.disponibilites.length > 0) {
                            updateCalendar(data.disponibilites);
                        } else {
                            console.error('Aucune disponibilité trouvée ou données mal formées.', data);
                        }
                    })

                    .catch(error => {
                        console.error('Failed to fetch availabilities:', error);
                        alert("Erreur lors de la récupération des disponibilités.");
                    });
            }

            document.getElementById('searchButton').addEventListener('click', function () {
                fetchAvailabilitiesAndUpdateCalendar();
            });

            function updateCalendar(disponibilites) {
                console.log("Updating calendar with:", disponibilites);
                calendar.removeAllEvents();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                disponibilites.forEach(disponibilite => {
                    const startDateTime = new Date(disponibilite.dateDisponibilite + 'T' + disponibilite.heureDisponibilite);
                    if (startDateTime >= today) {
                        const eventTitle = `${disponibilite.nomCoiffeur} - ${disponibilite.nomSalon}`;
                        calendar.addEvent({
                            title: eventTitle,
                            start: startDateTime.toISOString(),
                            allDay: false,
                            extendedProps: {
                                nomCoiffeur: disponibilite.nomCoiffeur,
                                nomSalon: disponibilite.nomSalon,
                                idDisponibilite: disponibilite.idDisponibilite,
                                idCoiffeur: disponibilite.idCoiffeur
                
                               
                            }
                        });
                    }
                });
                calendar.render();

            }
            var selectedEventId = null;

            function afficherDetailsRdv(info) {
                const event = info.event;
                selectedEventId = event.id;
                document.getElementById('detailCoiffeur').textContent = `Coiffeur: ${event.extendedProps.nomCoiffeur}`;
                document.getElementById('detailSalon').textContent = `Salon: ${event.extendedProps.nomSalon}`;
                const formattedDate = event.start.toLocaleDateString('fr-CA');
                const formattedTime = event.start.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('detailDateTime').textContent = `Date: ${formattedDate}`;
                document.getElementById('detailTime').textContent = `Heure: ${formattedTime}`;
                document.getElementById('detailsRDV').style.display = 'block';
            }

            function confirmerRdv() {
                const event = calendar.getEventById(selectedEventId);
                if (!event || !event.start) {
                    console.error("No event selected or event start date is undefined.");
                    return;
                }

                const dateRendezvous = event.start.toISOString().split('T')[0];
                const heureRendezvous = event.start.toISOString().split('T')[1].substring(0, 5);
                const idDisponibilite = event.extendedProps.idDisponibilite;
                const idClient = sessionStorage.getItem('idClient'); 
                const idCoiffeur = event.extendedProps.idCoiffeur;  

                const appointmentData = {
                    idDisponibilite,
                    idClient,
                    idCoiffeur,
                    token: sessionStorage.getItem('token')
                };

                console.log(appointmentData);  // Log pour vérifier les données

                fetch('/creerRendezVous', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(appointmentData)
                })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        if (data.idRendezvous) {
                            document.getElementById('detailsRDV').style.display = 'none';
                            calendar.refetchEvents();  // Rafraîchir les événements du calendrier si nécessaire
                        }
                    })
                    .catch(error => {
                        console.error('Error creating Rendezvous:', error);
                        alert("Failed to create Rendezvous: " + error.message);
                    });
            }


            document.getElementById('confirmButton').addEventListener('click', confirmerRdv);
        });
    </script>
</body>

</html>